name: ðŸ“¦ Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggered on version tags (e.g. v1.0.0, v2.1.0)

env:
  APP_NAME: "PhotoTransfer"

jobs:
  build-windows:
    name: ðŸªŸ Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ”¨ Build Executable
      run: |
        python build.py
    
    - name: ðŸ“ Check Build Output
      run: |
        if (Test-Path "dist/${{ env.APP_NAME }}.exe") {
          $size = (Get-Item "dist/${{ env.APP_NAME }}.exe").Length / 1MB
          Write-Host "âœ… Executable built successfully!"
          Write-Host "ðŸ“ Size: $([math]::Round($size, 1)) MB"
          Write-Host "ðŸ“‚ Location: dist/${{ env.APP_NAME }}.exe"
        } else {
          Write-Host "âŒ Executable not found!"
          exit 1
        }
    
    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: windows-executable
        path: dist/${{ env.APP_NAME }}.exe
        retention-days: 7

  create-release:
    name: ðŸš€ Create GitHub Release
    needs: build-windows
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for changelog
    
    - name: ðŸ“¥ Download Windows Executable
      uses: actions/download-artifact@v3
      with:
        name: windows-executable
        path: ./release/
    
    - name: ðŸ“‹ Generate Changelog
      id: changelog
      run: |
        # Extract version name from tag
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # Generate basic changelog
        echo "## ðŸŽ‰ Version $VERSION" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸ“¥ Downloads" >> CHANGELOG.md
        echo "- **Windows**: \`${{ env.APP_NAME }}.exe\` (Ready to use)" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸ”§ Installation" >> CHANGELOG.md
        echo "1. Download the \`.exe\` file" >> CHANGELOG.md
        echo "2. Double-click to launch the application" >> CHANGELOG.md
        echo "3. No installation required! ðŸŽ‰" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸ“ Changes" >> CHANGELOG.md
        
        # Get commits since last tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$PREV_TAG" ]; then
          echo "Changes since $PREV_TAG:" >> CHANGELOG.md
          git log --oneline --no-merges $PREV_TAG..HEAD | sed 's/^/- /' >> CHANGELOG.md
        else
          echo "- Initial version" >> CHANGELOG.md
        fi
        
        echo "" >> CHANGELOG.md
        echo "---" >> CHANGELOG.md
        echo "ðŸ’¡ **First time?** Check out the [user guide](../README.md)!" >> CHANGELOG.md
    
    - name: ðŸš€ Create Release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ steps.changelog.outputs.version }}
        name: "ðŸ“¸ Photo Organizer ${{ steps.changelog.outputs.version }}"
        bodyFile: CHANGELOG.md
        artifacts: "release/${{ env.APP_NAME }}.exe"
        token: ${{ secrets.GITHUB_TOKEN }}
        draft: false
        prerelease: false
        generateReleaseNotes: false
        allowUpdates: true
        artifactErrorsFailBuild: true
        
    - name: ðŸŽ‰ Release Summary
      run: |
        echo "## ðŸŽ‰ Release created successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ steps.changelog.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Platform**: Windows (x64)" >> $GITHUB_STEP_SUMMARY
        echo "**Fichier**: ${{ env.APP_NAME }}.exe" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.changelog.outputs.version }})" >> $GITHUB_STEP_SUMMARY

  # Optional job to notify on error
  notify-failure:
    name: ðŸ“¢ Notify Failure
    needs: [build-windows, create-release]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: ðŸ“¢ Failure Notification
      run: |
        echo "## âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Release generation failed." >> $GITHUB_STEP_SUMMARY
        echo "Check logs from previous jobs to identify the issue." >> $GITHUB_STEP_SUMMARY