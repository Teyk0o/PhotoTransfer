name: ðŸ“¦ Build and Release

on:
  push:
    tags:
      - 'v*'  # DÃ©clenchÃ© sur les tags de version (ex: v1.0.0, v2.1.0)

env:
  APP_NAME: "Organisateur-Photos"

jobs:
  build-windows:
    name: ðŸªŸ Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ”¨ Build Executable
      run: |
        python build.py
    
    - name: ðŸ“ Check Build Output
      run: |
        if (Test-Path "dist/${{ env.APP_NAME }}.exe") {
          $size = (Get-Item "dist/${{ env.APP_NAME }}.exe").Length / 1MB
          Write-Host "âœ… Executable built successfully!"
          Write-Host "ðŸ“ Size: $([math]::Round($size, 1)) MB"
          Write-Host "ðŸ“‚ Location: dist/${{ env.APP_NAME }}.exe"
        } else {
          Write-Host "âŒ Executable not found!"
          exit 1
        }
    
    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: windows-executable
        path: dist/${{ env.APP_NAME }}.exe
        retention-days: 7

  create-release:
    name: ðŸš€ Create GitHub Release
    needs: build-windows
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # RÃ©cupÃ©rer tout l'historique pour le changelog
    
    - name: ðŸ“¥ Download Windows Executable
      uses: actions/download-artifact@v3
      with:
        name: windows-executable
        path: ./release/
    
    - name: ðŸ“‹ Generate Changelog
      id: changelog
      run: |
        # Extraire le nom de la version depuis le tag
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # GÃ©nÃ©rer un changelog basique
        echo "## ðŸŽ‰ Version $VERSION" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸ“¥ TÃ©lÃ©chargements" >> CHANGELOG.md
        echo "- **Windows**: \`${{ env.APP_NAME }}.exe\` (PrÃªt Ã  utiliser)" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸ”§ Installation" >> CHANGELOG.md
        echo "1. TÃ©lÃ©chargez le fichier \`.exe\`" >> CHANGELOG.md
        echo "2. Double-cliquez pour lancer l'application" >> CHANGELOG.md
        echo "3. Aucune installation requise ! ðŸŽ‰" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸ“ Changements" >> CHANGELOG.md
        
        # RÃ©cupÃ©rer les commits depuis le dernier tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$PREV_TAG" ]; then
          echo "Changements depuis $PREV_TAG:" >> CHANGELOG.md
          git log --oneline --no-merges $PREV_TAG..HEAD | sed 's/^/- /' >> CHANGELOG.md
        else
          echo "- Version initiale" >> CHANGELOG.md
        fi
        
        echo "" >> CHANGELOG.md
        echo "---" >> CHANGELOG.md
        echo "ðŸ’¡ **PremiÃ¨re fois ?** Consultez le [guide d'utilisation](../README.md) !" >> CHANGELOG.md
    
    - name: ðŸš€ Create Release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ steps.changelog.outputs.version }}
        name: "ðŸ“¸ Organisateur de Photos ${{ steps.changelog.outputs.version }}"
        bodyFile: CHANGELOG.md
        artifacts: "release/${{ env.APP_NAME }}.exe"
        token: ${{ secrets.GITHUB_TOKEN }}
        draft: false
        prerelease: false
        generateReleaseNotes: false
        allowUpdates: true
        artifactErrorsFailBuild: true
        
    - name: ðŸŽ‰ Release Summary
      run: |
        echo "## ðŸŽ‰ Release crÃ©Ã©e avec succÃ¨s !" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ steps.changelog.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Plateforme**: Windows (x64)" >> $GITHUB_STEP_SUMMARY
        echo "**Fichier**: ${{ env.APP_NAME }}.exe" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [Voir la release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.changelog.outputs.version }})" >> $GITHUB_STEP_SUMMARY

  # Job optionnel pour notifier en cas d'erreur
  notify-failure:
    name: ðŸ“¢ Notify Failure
    needs: [build-windows, create-release]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: ðŸ“¢ Failure Notification
      run: |
        echo "## âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "La gÃ©nÃ©ration de la release a Ã©chouÃ©." >> $GITHUB_STEP_SUMMARY
        echo "VÃ©rifiez les logs des jobs prÃ©cÃ©dents pour identifier le problÃ¨me." >> $GITHUB_STEP_SUMMARY